#!/usr/bin/env php
<?php declare(strict_types=1);

use function Open\{open};

/**
 * Application entry point.
 * @return int The application exit code.
 */
function main(): int {
  global $argv;

  // Initialize the application.
  @cli_set_process_title('Open.php');

  // Parse the command line arguments.
  $options = getopt('a:bhvw', ['application:', 'background', 'help', 'version', 'wait'], $index);
  $rest = array_slice($argv, $index);

  if (isset($options['h']) || isset($options['help'])) {
    echo require __DIR__.'/../lib/Cli/usage.php', PHP_EOL;
    return 0;
  }

  if (isset($options['v']) || isset($options['version'])) {
    echo require __DIR__.'/../lib/Cli/version.g.php', PHP_EOL;
    return 0;
  }

  if (!count($rest)) {
    echo require __DIR__.'/../lib/Cli/usage.php', PHP_EOL;
    return 64;
  }

  // Run the program.
  $index = array_search('--', $argv);
  open($rest[0], [
    'application' => $options['a'] ?? $options['application'] ?? '',
    'arguments' => $index ? array_slice($argv, $index + 1) : [],
    'background' => isset($options['b']) || isset($options['background']),
    'wait' => isset($options['w']) || isset($options['wait'])
  ]);

  return 0;
}

// Start the application.
try {
  $fileInfo = new SplFileInfo(__DIR__.'/../../../autoload.php');
  require_once $fileInfo->isFile() ? $fileInfo->getPathname() : __DIR__.'/../vendor/autoload.php';
  exit(main());
}

catch (Throwable $e) {
  echo $e->getMessage(), PHP_EOL;
  exit(1);
}
